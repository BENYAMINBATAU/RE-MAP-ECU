<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DIY ECU TOOL ‚Äî Honda K-Line via Arduino</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap');

  :root {
    --bg: #070a0f;
    --bg2: #0c1018;
    --bg3: #111720;
    --border: #1e2d40;
    --accent: #00e5ff;
    --accent2: #ff6b35;
    --accent3: #39ff14;
    --warn: #ffcc00;
    --danger: #ff2244;
    --text: #c8d8e8;
    --text2: #607080;
    --glow: 0 0 12px #00e5ff44;
    --glow2: 0 0 12px #ff6b3544;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    font-size: 15px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid scanlines background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,229,255,0.015) 2px, rgba(0,229,255,0.015) 4px),
      repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(0,229,255,0.01) 40px, rgba(0,229,255,0.011) 41px);
    pointer-events: none;
    z-index: 0;
  }

  .wrap { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 0 16px 40px; }

  /* ===== HEADER ===== */
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 0 10px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 16px;
    flex-wrap: wrap; gap: 10px;
  }
  .logo {
    font-family: 'Orbitron', monospace;
    font-size: 18px;
    font-weight: 900;
    letter-spacing: 2px;
    color: var(--accent);
    text-shadow: var(--glow);
  }
  .logo span { color: var(--accent2); }
  .logo sub { font-size: 9px; color: var(--text2); display: block; letter-spacing: 4px; margin-top: -4px; font-family: 'Share Tech Mono'; }

  .status-bar {
    display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
  }
  .pill {
    font-family: 'Share Tech Mono';
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: var(--bg2);
    color: var(--text2);
    letter-spacing: 1px;
  }
  .pill.online { border-color: var(--accent3); color: var(--accent3); box-shadow: 0 0 8px #39ff1444; }
  .pill.warn { border-color: var(--warn); color: var(--warn); }
  .pill.danger { border-color: var(--danger); color: var(--danger); }

  /* ===== CONNECT BAR ===== */
  .connect-bar {
    display: grid;
    grid-template-columns: 1fr auto auto auto auto;
    gap: 10px; align-items: center;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 16px;
  }

  select, input[type=number] {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'Share Tech Mono';
    font-size: 12px;
    padding: 6px 10px;
    border-radius: 5px;
    outline: none;
    width: 100%;
  }
  select:focus, input:focus { border-color: var(--accent); }

  button {
    font-family: 'Orbitron', monospace;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1px;
    padding: 7px 14px;
    border-radius: 5px;
    border: 1px solid var(--accent);
    background: transparent;
    color: var(--accent);
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  button:hover { background: var(--accent); color: var(--bg); box-shadow: var(--glow); }
  button.danger { border-color: var(--danger); color: var(--danger); }
  button.danger:hover { background: var(--danger); color: #fff; }
  button.warn { border-color: var(--warn); color: var(--warn); }
  button.warn:hover { background: var(--warn); color: var(--bg); }
  button.green { border-color: var(--accent3); color: var(--accent3); }
  button.green:hover { background: var(--accent3); color: var(--bg); }
  button.orange { border-color: var(--accent2); color: var(--accent2); }
  button.orange:hover { background: var(--accent2); color: #fff; }
  button:disabled { opacity: 0.3; cursor: not-allowed; }

  /* ===== TABS ===== */
  .tabs {
    display: flex; gap: 4px;
    margin-bottom: 16px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
  }
  .tab {
    font-family: 'Orbitron', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    padding: 8px 16px;
    border: 1px solid transparent;
    border-bottom: none;
    border-radius: 6px 6px 0 0;
    cursor: pointer;
    color: var(--text2);
    background: transparent;
    transition: all 0.15s;
    position: relative;
    top: 1px;
  }
  .tab:hover { color: var(--text); }
  .tab.active {
    border-color: var(--border);
    border-bottom-color: var(--bg);
    background: var(--bg);
    color: var(--accent);
    box-shadow: inset 0 2px 0 var(--accent);
  }

  .panel { display: none; }
  .panel.active { display: block; }

  /* ===== CARDS & GRID ===== */
  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .grid3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
  .grid4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; }

  .card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
  }
  .card-title {
    font-family: 'Orbitron', monospace;
    font-size: 9px;
    letter-spacing: 2px;
    color: var(--text2);
    margin-bottom: 12px;
    text-transform: uppercase;
    display: flex; justify-content: space-between; align-items: center;
  }

  /* ===== BIG GAUGES ===== */
  .gauge-row { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 14px; }
  .gauge {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 10px 10px;
    text-align: center;
  }
  .gauge-val {
    font-family: 'Orbitron', monospace;
    font-size: 26px;
    font-weight: 900;
    color: var(--accent);
    line-height: 1;
    text-shadow: var(--glow);
    transition: color 0.2s;
  }
  .gauge-val.warn { color: var(--warn); text-shadow: 0 0 12px #ffcc0066; }
  .gauge-val.danger { color: var(--danger); text-shadow: 0 0 12px #ff224466; }
  .gauge-unit {
    font-family: 'Share Tech Mono';
    font-size: 10px;
    color: var(--text2);
    margin-top: 2px;
  }
  .gauge-label {
    font-family: 'Rajdhani';
    font-size: 11px;
    color: var(--text2);
    margin-top: 6px;
    letter-spacing: 1px;
  }
  .gauge-bar { height: 3px; background: var(--border); border-radius: 2px; margin-top: 6px; overflow: hidden; }
  .gauge-bar-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.3s, background 0.2s; }

  /* ===== SENSOR TABLE ===== */
  .sensor-table { width: 100%; border-collapse: collapse; font-family: 'Share Tech Mono'; font-size: 12px; }
  .sensor-table th { color: var(--text2); text-align: left; font-size: 10px; letter-spacing: 1px; padding: 4px 8px; border-bottom: 1px solid var(--border); }
  .sensor-table td { padding: 5px 8px; border-bottom: 1px solid #1a2030; }
  .sensor-table tr:hover td { background: #0e1520; }
  .val-cell { color: var(--accent); font-weight: bold; }
  .raw-cell { color: var(--text2); }

  /* ===== OSCILLOSCOPE ===== */
  canvas { display: block; width: 100%; }
  .osc-wrap { background: #020508; border: 1px solid var(--border); border-radius: 6px; padding: 8px; }
  .osc-legend { display: flex; gap: 14px; margin-top: 6px; font-family: 'Share Tech Mono'; font-size: 10px; }
  .osc-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; vertical-align: middle; }

  /* ===== FUEL/IGN MAP ===== */
  .map-wrap { overflow-x: auto; }
  .map-table { border-collapse: collapse; font-family: 'Share Tech Mono'; font-size: 11px; }
  .map-table th { padding: 4px 6px; color: var(--text2); font-size: 9px; text-align: center; background: var(--bg3); }
  .map-table td {
    width: 38px; height: 30px; text-align: center; padding: 0; cursor: pointer;
    border: 1px solid #0d1520;
    transition: all 0.1s;
    font-size: 11px;
  }
  .map-table td:hover { border-color: var(--accent); box-shadow: inset 0 0 0 1px var(--accent); z-index: 1; }
  .map-table td.selected { border-color: var(--accent2)!important; box-shadow: inset 0 0 0 2px var(--accent2); }
  .map-cell-input { width: 100%; height: 100%; background: transparent; border: none; text-align: center; font-family: 'Share Tech Mono'; font-size: 11px; outline: none; cursor: pointer; color: inherit; }

  /* ===== FLASH ===== */
  .progress-wrap { background: var(--bg3); border-radius: 4px; height: 18px; overflow: hidden; border: 1px solid var(--border); }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent3)); border-radius: 4px; transition: width 0.3s; position: relative; }
  .progress-fill::after { content: ''; position: absolute; inset: 0; background: repeating-linear-gradient(90deg, transparent, transparent 8px, rgba(255,255,255,0.05) 8px, rgba(255,255,255,0.05) 9px); animation: stripe 0.5s linear infinite; }
  @keyframes stripe { from { background-position: 0 0; } to { background-position: 9px 0; } }

  .hex-display {
    font-family: 'Share Tech Mono';
    font-size: 10px;
    background: #020508;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px;
    height: 120px;
    overflow-y: auto;
    color: #4a7a9b;
    line-height: 1.7;
  }
  .hex-display .addr { color: var(--text2); }
  .hex-display .changed { color: var(--accent2)!important; }
  .hex-display .zero { color: #1e3040; }

  /* ===== DTC ===== */
  .dtc-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 12px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-left: 3px solid var(--danger);
    border-radius: 5px;
    margin-bottom: 8px;
    font-family: 'Share Tech Mono';
    font-size: 12px;
  }
  .dtc-item.pending { border-left-color: var(--warn); }
  .dtc-item.historic { border-left-color: var(--text2); }
  .dtc-code { color: var(--accent2); font-weight: bold; }
  .dtc-desc { color: var(--text); flex: 1; padding: 0 12px; }
  .dtc-status { color: var(--text2); font-size: 10px; }

  /* ===== TERMINAL ===== */
  .terminal {
    font-family: 'Share Tech Mono';
    font-size: 12px;
    background: #020508;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px;
    height: 220px;
    overflow-y: auto;
    line-height: 1.8;
  }
  .terminal .t-rx { color: var(--accent3); }
  .terminal .t-tx { color: var(--accent); }
  .terminal .t-sys { color: var(--text2); }
  .terminal .t-err { color: var(--danger); }
  .terminal .t-warn { color: var(--warn); }

  .term-input-row { display: flex; gap: 8px; margin-top: 8px; }
  .term-input {
    flex: 1;
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--accent3);
    font-family: 'Share Tech Mono';
    font-size: 12px;
    padding: 6px 10px;
    border-radius: 5px;
    outline: none;
  }
  .term-input:focus { border-color: var(--accent3); }

  .btn-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }

  /* ===== ARDUINO FIRMWARE PANEL ===== */
  .code-block {
    font-family: 'Share Tech Mono';
    font-size: 11px;
    background: #020508;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 14px;
    overflow-x: auto;
    color: #7ab8d4;
    line-height: 1.7;
    white-space: pre;
    max-height: 480px;
    overflow-y: auto;
  }
  .code-block .kw { color: #c792ea; }
  .code-block .fn { color: #82aaff; }
  .code-block .str { color: #c3e88d; }
  .code-block .num { color: #f78c6c; }
  .code-block .cm { color: #546e7a; }

  /* ===== REMAP PARAMS ===== */
  .param-row {
    display: flex; align-items: center; gap: 12px;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
  }
  .param-label { flex: 0 0 160px; color: var(--text2); font-size: 13px; }
  .param-input {
    width: 90px;
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--accent);
    font-family: 'Share Tech Mono';
    font-size: 13px;
    padding: 4px 8px;
    border-radius: 4px;
    outline: none;
    text-align: right;
  }
  .param-input:focus { border-color: var(--accent); }
  .param-unit { color: var(--text2); font-size: 11px; width: 40px; }
  .param-range { flex: 1; }
  input[type=range] { width: 100%; accent-color: var(--accent); cursor: pointer; }

  /* ===== ECU SELECTOR ===== */
  .ecu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
  .ecu-card {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .ecu-card:hover, .ecu-card.selected {
    border-color: var(--accent);
    background: #0a1825;
    box-shadow: var(--glow);
  }
  .ecu-model { font-family: 'Share Tech Mono'; font-size: 11px; color: var(--accent); margin-bottom: 4px; }
  .ecu-name { font-size: 14px; font-weight: 600; color: var(--text); }
  .ecu-chip { font-size: 11px; color: var(--text2); margin-top: 2px; }
  .ecu-tags { display: flex; gap: 4px; margin-top: 6px; }
  .tag { font-size: 9px; padding: 2px 6px; border-radius: 10px; background: var(--bg); border: 1px solid var(--border); color: var(--text2); }
  .tag.ok { border-color: var(--accent3); color: var(--accent3); }
  .tag.partial { border-color: var(--warn); color: var(--warn); }

  /* ===== MEMORY MAP ===== */
  .memmap { font-family: 'Share Tech Mono'; font-size: 11px; line-height: 2; }
  .memmap-row { display: flex; gap: 10px; align-items: center; padding: 2px 0; border-bottom: 1px solid #0d1520; }
  .memmap-addr { color: var(--accent2); width: 70px; }
  .memmap-bar { flex: 1; height: 14px; background: var(--bg3); border-radius: 3px; overflow: hidden; }
  .memmap-fill { height: 100%; border-radius: 3px; }
  .memmap-label { width: 220px; color: var(--text); }
  .memmap-size { width: 60px; color: var(--text2); text-align: right; }

  /* scrollbar */
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  @media (max-width: 900px) {
    .gauge-row { grid-template-columns: repeat(3, 1fr); }
    .grid2, .grid3, .grid4 { grid-template-columns: 1fr; }
    .connect-bar { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 600px) {
    .gauge-row { grid-template-columns: repeat(2, 1fr); }
    .connect-bar { grid-template-columns: 1fr; }
  }

  .sep { height: 14px; }
  .note { font-size: 12px; color: var(--text2); padding: 8px 12px; background: #0a1018; border-left: 2px solid var(--border); border-radius: 3px; margin-bottom: 10px; }
  .note.warn { border-left-color: var(--warn); color: #c8a030; }
  .note.danger { border-left-color: var(--danger); color: #c83040; }
  .note.ok { border-left-color: var(--accent3); color: #40b840; }

  .blink { animation: blink 1s step-end infinite; }
  @keyframes blink { 50% { opacity: 0; } }

  .spinner { display: inline-block; width: 10px; height: 10px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; vertical-align: middle; margin-right: 6px; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div class="wrap">

<!-- HEADER -->
<header>
  <div class="logo">
    DIY¬∑ECU<span>TOOL</span>
    <sub>Arduino K-Line Bridge ¬∑ Honda Keihin ¬∑ Web Serial API</sub>
  </div>
  <div class="status-bar">
    <span class="pill" id="pillPort">PORT: ‚Äî</span>
    <span class="pill" id="pillBaud">10400 BAUD</span>
    <span class="pill" id="pillEcu">ECU: ‚Äî</span>
    <span class="pill" id="pillStatus">OFFLINE</span>
  </div>
</header>

<!-- CONNECT BAR -->
<div class="connect-bar">
  <select id="ecuSelect" onchange="onEcuChange()">
    <option value="">‚Äî Pilih ECU ‚Äî</option>
    <option value="K56-N01">Vario 150 / Sonic 150 ¬∑ K56-N01 ¬∑ R8C ¬∑ 56KB</option>
    <option value="K45N-NA1">Vario 125 ¬∑ K45N-NA1 ¬∑ H8C ¬∑ 48KB</option>
    <option value="K93-N01">Beat FI ¬∑ K93-N01 ¬∑ H8C ¬∑ 48KB</option>
    <option value="MKJ-D51">CBR 150 ¬∑ MKJ-D51 ¬∑ R8C ¬∑ 56KB</option>
    <option value="KYJ-922">CBR 250 ¬∑ KYJ-922 ¬∑ R8C ¬∑ 56KB</option>
  </select>
  <button onclick="connectSerial()" id="btnConnect" class="green">‚ö° CONNECT</button>
  <button onclick="disconnectSerial()" id="btnDisconnect" class="danger" disabled>‚úï DISC</button>
  <button onclick="sendDemo()" class="warn">‚ñ∑ DEMO</button>
  <button onclick="showTab('firmware')" class="orange">üî© ARDUINO</button>
</div>

<!-- TABS -->
<div class="tabs">
  <div class="tab active" onclick="showTab('live')" id="tab-live">üìä LIVE DATA</div>
  <div class="tab" onclick="showTab('flash')" id="tab-flash">üíæ FLASH</div>
  <div class="tab" onclick="showTab('remap')" id="tab-remap">üîß REMAP</div>
  <div class="tab" onclick="showTab('dtc')" id="tab-dtc">‚ö† DTC</div>
  <div class="tab" onclick="showTab('terminal')" id="tab-terminal">üìü TERMINAL</div>
  <div class="tab" onclick="showTab('firmware')" id="tab-firmware">üî© FIRMWARE</div>
  <div class="tab" onclick="showTab('wiring')" id="tab-wiring">üîå WIRING</div>
</div>

<!-- ===== PANEL: LIVE DATA ===== -->
<div class="panel active" id="panel-live">
  <div class="gauge-row">
    <div class="gauge">
      <div class="gauge-val" id="g-rpm">0</div>
      <div class="gauge-unit">RPM</div>
      <div class="gauge-bar"><div class="gauge-bar-fill" id="b-rpm" style="width:0%"></div></div>
      <div class="gauge-label">ENGINE SPEED</div>
    </div>
    <div class="gauge">
      <div class="gauge-val" id="g-spd">0</div>
      <div class="gauge-unit">KM/H</div>
      <div class="gauge-bar"><div class="gauge-bar-fill" id="b-spd" style="width:0%;background:var(--accent2)"></div></div>
      <div class="gauge-label">VEHICLE SPEED</div>
    </div>
    <div class="gauge">
      <div class="gauge-val" id="g-tps">0</div>
      <div class="gauge-unit">%</div>
      <div class="gauge-bar"><div class="gauge-bar-fill" id="b-tps" style="width:0%;background:var(--accent3)"></div></div>
      <div class="gauge-label">THROTTLE</div>
    </div>
    <div class="gauge">
      <div class="gauge-val" id="g-ect">‚Äî</div>
      <div class="gauge-unit">¬∞C</div>
      <div class="gauge-bar"><div class="gauge-bar-fill" id="b-ect" style="width:0%;background:#ff6060"></div></div>
      <div class="gauge-label">COOLANT</div>
    </div>
    <div class="gauge">
      <div class="gauge-val" id="g-map">‚Äî</div>
      <div class="gauge-unit">kPa</div>
      <div class="gauge-bar"><div class="gauge-bar-fill" id="b-map" style="width:0%;background:var(--warn)"></div></div>
      <div class="gauge-label">MAP</div>
    </div>
    <div class="gauge">
      <div class="gauge-val" id="g-o2">‚Äî</div>
      <div class="gauge-unit">V (Œª)</div>
      <div class="gauge-bar"><div class="gauge-bar-fill" id="b-o2" style="width:0%;background:#aa44ff"></div></div>
      <div class="gauge-label">O2 SENSOR</div>
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <div class="card-title">SENSOR READINGS <span id="liveTag" style="color:var(--danger);font-size:10px">‚óè OFFLINE</span></div>
      <table class="sensor-table">
        <thead><tr><th>PARAMETER</th><th>RAW</th><th>VALUE</th><th>FORMULA</th></tr></thead>
        <tbody id="sensorTbody">
          <tr><td>Engine RPM</td><td class="raw-cell" id="r-rpm">--</td><td class="val-cell" id="v-rpm">0 rpm</td><td style="color:var(--text2);font-size:10px">(B0¬´8|B1)√ó0.25</td></tr>
          <tr><td>Vehicle Speed</td><td class="raw-cell" id="r-spd">--</td><td class="val-cell" id="v-spd">0 km/h</td><td style="color:var(--text2);font-size:10px">B3 direct</td></tr>
          <tr><td>Throttle (TPS)</td><td class="raw-cell" id="r-tps">--</td><td class="val-cell" id="v-tps">0 %</td><td style="color:var(--text2);font-size:10px">B5√ó100/255</td></tr>
          <tr><td>Coolant Temp</td><td class="raw-cell" id="r-ect">--</td><td class="val-cell" id="v-ect">-- ¬∞C</td><td style="color:var(--text2);font-size:10px">B0‚àí40</td></tr>
          <tr><td>Intake Air Temp</td><td class="raw-cell" id="r-iat">--</td><td class="val-cell" id="v-iat">-- ¬∞C</td><td style="color:var(--text2);font-size:10px">B1‚àí40</td></tr>
          <tr><td>MAP Sensor</td><td class="raw-cell" id="r-map">--</td><td class="val-cell" id="v-map">-- kPa</td><td style="color:var(--text2);font-size:10px">B2 direct kPa</td></tr>
          <tr><td>O2 Sensor</td><td class="raw-cell" id="r-o2">--</td><td class="val-cell" id="v-o2">-- V</td><td style="color:var(--text2);font-size:10px">B3√ó5/255</td></tr>
          <tr><td>Battery Volt</td><td class="raw-cell" id="r-bat">--</td><td class="val-cell" id="v-bat">-- V</td><td style="color:var(--text2);font-size:10px">B7√ó18/255</td></tr>
          <tr><td>Injector PW</td><td class="raw-cell" id="r-inj">--</td><td class="val-cell" id="v-inj">-- ms</td><td style="color:var(--text2);font-size:10px">B0√ó0.256</td></tr>
          <tr><td>Ignition Adv</td><td class="raw-cell" id="r-ign">--</td><td class="val-cell" id="v-ign">-- ¬∞</td><td style="color:var(--text2);font-size:10px">B1/2‚àí64</td></tr>
          <tr><td>STFT</td><td class="raw-cell" id="r-stft">--</td><td class="val-cell" id="v-stft">-- %</td><td style="color:var(--text2);font-size:10px">(B2‚àí128)√ó100/128</td></tr>
          <tr><td>LTFT</td><td class="raw-cell" id="r-ltft">--</td><td class="val-cell" id="v-ltft">-- %</td><td style="color:var(--text2);font-size:10px">(B3‚àí128)√ó100/128</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="card-title">OSCILLOSCOPE ‚Äî 4CH</div>
      <div class="osc-wrap">
        <canvas id="oscCanvas" height="180"></canvas>
      </div>
      <div class="osc-legend">
        <span><span class="osc-dot" style="background:#00e5ff"></span>RPM</span>
        <span><span class="osc-dot" style="background:#ff6b35"></span>O2</span>
        <span><span class="osc-dot" style="background:#39ff14"></span>TPS</span>
        <span><span class="osc-dot" style="background:#ffcc00"></span>INJ PW</span>
      </div>
      <div class="sep"></div>
      <div class="btn-row">
        <button onclick="sendCmd('TBL00')" id="btnTbl00">TBL-00 RPM/SPD</button>
        <button onclick="sendCmd('TBL10')" id="btnTbl10">TBL-10 TEMP/O2</button>
        <button onclick="sendCmd('TBL11')" id="btnTbl11">TBL-11 FUEL/IGN</button>
        <button onclick="sendCmd('TBL60')" id="btnTbl60">TBL-60 EXT</button>
        <button onclick="sendCmd('KEEPALIVE')">KEEPALIVE</button>
        <button onclick="exportCSV()" class="green">‚Üì CSV</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== PANEL: FLASH ===== -->
<div class="panel" id="panel-flash">
  <div class="note warn">‚ö† Flash read/write dapat merusak ECU jika terjadi kesalahan. Selalu backup dulu sebelum write. Gunakan ECU trainer/spare untuk percobaan pertama.</div>
  <div class="grid2">
    <div class="card">
      <div class="card-title">FLASH READ</div>
      <div class="note">Protocol: Honda FID via K-Line ¬∑ CMD: 72 07 76 ADDR_H ADDR_L LEN CS ¬∑ Max 256 byte/frame</div>
      <div class="sep"></div>
      <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap">
        <button onclick="flashRead()" class="green" id="btnFlashRead">üìñ READ FULL FLASH</button>
        <button onclick="readTable()" id="btnReadTable">READ TABLE</button>
        <button onclick="saveFlash()" id="btnSaveFlash" disabled>üíæ SAVE .BIN</button>
        <button onclick="loadFlash()" class="orange">üìÇ LOAD .BIN</button>
        <input type="file" id="fileInput" accept=".bin" style="display:none" onchange="onFileLoad(event)">
      </div>
      <div class="progress-wrap" style="margin-bottom:8px">
        <div class="progress-fill" id="flashProg" style="width:0%"></div>
      </div>
      <div style="font-family:'Share Tech Mono';font-size:11px;color:var(--text2);margin-bottom:8px" id="flashStatus">Flash belum dibaca. Klik READ FULL FLASH.</div>
      <div class="hex-display" id="hexDisplay">‚Äî</div>
      <div style="margin-top:6px;font-family:'Share Tech Mono';font-size:10px;color:var(--text2)" id="flashInfo">Size: 0 bytes ¬∑ Checksum: --</div>
    </div>
    <div class="card">
      <div class="card-title">FLASH WRITE</div>
      <div class="note danger">‚ö† HANYA untuk ECU trainer/bench! Pastikan .bin valid sebelum write!</div>
      <div class="sep"></div>
      <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap">
        <button onclick="flashWrite()" class="danger" id="btnWrite" disabled>‚ö° WRITE FLASH</button>
        <button onclick="flashVerify()" id="btnVerify" disabled>‚úì VERIFY</button>
      </div>
      <div class="progress-wrap" style="margin-bottom:8px">
        <div class="progress-fill" id="writeProg" style="width:0%;background:linear-gradient(90deg,var(--danger),var(--accent2))"></div>
      </div>
      <div style="font-family:'Share Tech Mono';font-size:11px;color:var(--text2)" id="writeStatus">Load .bin terlebih dahulu.</div>
      <div class="sep"></div>
      <div class="card-title" style="margin-top:10px">KEIHIN FLASH MAP ‚Äî K56-N01 / K93-N01</div>
      <div class="memmap" id="memmap"></div>
    </div>
  </div>
</div>

<!-- ===== PANEL: REMAP ===== -->
<div class="panel" id="panel-remap">
  <div class="grid2">
    <div class="card">
      <div class="card-title">FUEL MAP ‚Äî RPM √ó MAP (kPa) <span style="font-size:9px;color:var(--text2)">128=STOCK ¬∑ >128=RICHER ¬∑ &lt;128=LEANER</span></div>
      <div class="map-wrap" id="fuelMapWrap"></div>
      <div class="sep"></div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span style="font-size:12px;color:var(--text2)">Selected: <span id="fuelSel">‚Äî</span></span>
        <input type="number" id="fuelVal" style="width:70px" min="0" max="255" value="128">
        <button onclick="setFuelCell()">SET</button>
        <input type="number" id="fuelTrimPct" style="width:60px" value="0" min="-30" max="30">
        <span style="font-size:11px;color:var(--text2)">%</span>
        <button onclick="globalTrim('fuel')">GLOBAL TRIM</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">IGNITION MAP ‚Äî RPM √ó MAP (kPa) <span style="font-size:9px;color:var(--text2)">val/2‚àí64 = ¬∞BTDC</span></div>
      <div class="map-wrap" id="ignMapWrap"></div>
      <div class="sep"></div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span style="font-size:12px;color:var(--text2)">Selected: <span id="ignSel">‚Äî</span></span>
        <input type="number" id="ignVal" style="width:70px" min="0" max="255" value="128">
        <button onclick="setIgnCell()">SET</button>
        <input type="number" id="ignTrimDeg" style="width:60px" value="0" min="-20" max="20">
        <span style="font-size:11px;color:var(--text2)">¬∞</span>
        <button onclick="globalTrim('ign')">GLOBAL TRIM</button>
      </div>
    </div>
  </div>
  <div class="sep"></div>
  <div class="card">
    <div class="card-title">REMAP PARAMETER LANGSUNG <span style="font-size:9px;color:var(--danger)">‚óè Tulis ke ECU via K-Line saat stasioner</span></div>
    <div id="paramRows"></div>
    <div class="sep"></div>
    <div class="btn-row">
      <button onclick="applyRemap()" class="green">‚ö° APPLY REMAP</button>
      <button onclick="resetRemap()" class="danger">‚Ü∫ RESET STOCK</button>
      <button onclick="saveProfile()" class="orange">üíæ SAVE PROFILE</button>
      <button onclick="loadProfile()">üìÇ LOAD PROFILE</button>
      <input type="file" id="profileInput" accept=".json" style="display:none" onchange="onProfileLoad(event)">
    </div>
    <div class="sep"></div>
    <div style="font-family:'Share Tech Mono';font-size:11px;color:var(--text2);padding:6px 0" id="remapQueue">Queue: kosong</div>
  </div>
</div>

<!-- ===== PANEL: DTC ===== -->
<div class="panel" id="panel-dtc">
  <div class="card">
    <div class="card-title">ACTIVE FAULT CODES</div>
    <div class="btn-row" style="margin-bottom:12px">
      <button onclick="sendCmd('RDTC')" class="green">üìñ READ DTC</button>
      <button onclick="clearDtc()" class="danger">üóë CLEAR ALL</button>
      <button onclick="readFreezeFrame()">üì∑ FREEZE FRAME</button>
    </div>
    <div id="dtcList"><div style="color:var(--text2);font-family:'Share Tech Mono';font-size:12px;padding:12px 0">Belum ada DTC dibaca. Klik READ DTC setelah connect.</div></div>
    <div class="sep"></div>
    <div class="card-title">HONDA KEIHIN DTC REFERENCE</div>
    <table class="sensor-table" id="dtcRefTable" style="font-size:11px"></table>
  </div>
</div>

<!-- ===== PANEL: TERMINAL ===== -->
<div class="panel" id="panel-terminal">
  <div class="card">
    <div class="card-title">RAW K-LINE TERMINAL <span style="font-size:9px;color:var(--text2)">Format: hex bytes spasi-separated ¬∑ ex: 72 05 71 00 CS</span></div>
    <div class="terminal" id="terminal">[SYS] DIY ECU Tool ‚Äî Arduino K-Line Bridge ready.<br>[SYS] Web Serial API ¬∑ Chrome 89+ required.<br>[SYS] Ketik perintah hex atau gunakan tombol shortcut di bawah.</div>
    <div class="term-input-row">
      <input class="term-input" id="termInput" placeholder="hex bytes: 72 05 71 00 18" onkeydown="if(event.key==='Enter')sendRaw()">
      <button onclick="sendRaw()" class="green">SEND</button>
      <button onclick="clearTerm()">CLR</button>
    </div>
    <div class="btn-row">
      <button onclick="sendCmd('INIT')">INIT</button>
      <button onclick="sendCmd('WAKE')">WAKE</button>
      <button onclick="sendCmd('TBL00')">TBL-00</button>
      <button onclick="sendCmd('TBL10')">TBL-10</button>
      <button onclick="sendCmd('TBL11')">TBL-11</button>
      <button onclick="sendCmd('TBL60')">TBL-60</button>
      <button onclick="sendCmd('RDTC')">READ DTC</button>
      <button onclick="sendCmd('CLRDTC')" class="danger">CLR DTC</button>
      <button onclick="sendCmd('KEEPALIVE')">KEEPALIVE</button>
      <button onclick="sendCmd('FLASHRD')">FLASH-READ</button>
    </div>
  </div>
</div>

<!-- ===== PANEL: FIRMWARE ===== -->
<div class="panel" id="panel-firmware">
  <div class="note ok">‚úì Upload firmware ini ke Arduino UNO/Nano. Setelah upload, sambungkan ke K-Line interface. Buka app ini di Chrome dan klik CONNECT.</div>
  <div class="grid2">
    <div class="card" style="grid-column:1/-1">
      <div class="card-title">ARDUINO FIRMWARE ‚Äî DIY K-LINE BRIDGE <span style="float:right"><button onclick="copyFirmware()" class="green" style="font-size:9px;padding:4px 10px">üìã COPY</button></span></div>
      <div class="code-block" id="firmwareCode"></div>
    </div>
  </div>
  <div class="sep"></div>
  <div class="grid2">
    <div class="card">
      <div class="card-title">CARA UPLOAD FIRMWARE</div>
      <div style="font-size:13px;line-height:2;color:var(--text)">
        1. Install <b>Arduino IDE</b> dari arduino.cc<br>
        2. Sambungkan Arduino UNO/Nano via USB<br>
        3. Copy firmware di atas ‚Üí paste ke Arduino IDE<br>
        4. Pilih Board: <span style="color:var(--accent);font-family:'Share Tech Mono'">Arduino Uno</span> atau <span style="color:var(--accent);font-family:'Share Tech Mono'">Nano</span><br>
        5. Pilih Port yang sesuai<br>
        6. Klik <b>Upload</b> (‚áí)<br>
        7. Setelah upload, sambungkan K-Line hardware<br>
        8. Buka app ini di <b>Chrome 89+</b><br>
        9. Pilih ECU ‚Üí klik <b>‚ö° CONNECT</b>
      </div>
    </div>
    <div class="card">
      <div class="card-title">PROTOCOL ARDUINO ‚Üî BROWSER</div>
      <div style="font-family:'Share Tech Mono';font-size:11px;line-height:2;color:var(--text2)">
        <span style="color:var(--accent)">Serial (USB) 115200 baud</span><br>
        Browser ‚Üí Arduino: <span style="color:var(--accent2)">CMD:HEX_BYTES\n</span><br>
        Arduino ‚Üí Browser: <span style="color:var(--accent3)">RX:HEX_BYTES\n</span><br>
        Status: <span style="color:var(--warn)">STATUS:text\n</span><br>
        Error: <span style="color:var(--danger)">ERR:text\n</span><br><br>
        <span style="color:var(--text2)">Arduino melakukan K-Line init (slow init 10400 baud)<br>
        timing dicontrol dari firmware.<br>
        Browser tinggal kirim command, terima response.</span>
      </div>
    </div>
  </div>
</div>

<!-- ===== PANEL: WIRING ===== -->
<div class="panel" id="panel-wiring">
  <div class="grid2">
    <div class="card">
      <div class="card-title">SKEMA WIRING ‚Äî Arduino ‚Üí K-Line ‚Üí ECU Honda</div>
      <pre style="font-family:'Share Tech Mono';font-size:11px;color:var(--text2);line-height:2;overflow-x:auto;white-space:pre">
<span style="color:var(--accent)">Arduino UNO/Nano</span>              <span style="color:var(--accent2)">K-Line Circuit</span>            <span style="color:var(--accent3)">Honda ECU DLC</span>

  Pin D2 (TX) ‚îÄ‚îÄ‚îÄ‚îÄ[510Œ©]‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ K-LINE
                             ‚îÇ                    (DLC1 ‚Äî Biru/Putih)
  Pin D3 (RX) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
                             ‚îÇ
                          [L9637D]  <span style="color:var(--warn)">‚Üê IC transceiver (DISARANKAN)</span>
                          atau
                       [Diode+R] <span style="color:var(--warn)">‚Üê Versi sederhana</span>
                             ‚îÇ
                           +12V ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ BATT+ ECU / IG ON

  GND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ GND ECU

<span style="color:var(--accent)">DLC HONDA 4-PIN SUMITOMO HM090:</span>
  Pin 1 ‚Äî GND
  Pin 2 ‚Äî K-LINE (ISO 9141)
  Pin 3 ‚Äî +12V Battery
  Pin 4 ‚Äî tidak digunakan

<span style="color:var(--accent)">VERSI SEDERHANA (tanpa IC):</span>
  Arduino D2 (TX) ‚îÄ[510Œ©]‚îÄ‚î¨‚îÄ K-LINE
                           ‚îÇ
  Arduino D3 (RX) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
  1N4148 diode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
                           ‚îÇ
  +12V (dari ECU) ‚îÄ[10kŒ©]‚îÄ‚îÄ‚îò

<span style="color:var(--accent)">VERSI DENGAN L9637D (lebih aman):</span>
  Arduino TX ‚îÄ‚îÄ‚îÄ L9637D TX-IN
  Arduino RX ‚îÄ‚îÄ‚îÄ L9637D RX-OUT
  L9637D K-LINE ‚îÄ‚îÄ‚îÄ DLC Pin 2
  L9637D VCC ‚îÄ‚îÄ‚îÄ +5V Arduino
  L9637D Vbat ‚îÄ‚îÄ‚îÄ +12V ECU
</pre>
    </div>
    <div class="card">
      <div class="card-title">KOMPONEN YANG DIBUTUHKAN</div>
      <table class="sensor-table" style="font-size:12px">
        <thead><tr><th>KOMPONEN</th><th>NILAI</th><th>FUNGSI</th><th>HARGA EST.</th></tr></thead>
        <tbody>
          <tr><td>Arduino UNO/Nano</td><td>ATmega328P</td><td>USB-Serial bridge</td><td style="color:var(--accent3)">Rp 35‚Äì60rb</td></tr>
          <tr><td>L9637D atau MC33660</td><td>ISO K-LINE IC</td><td>K-Line transceiver</td><td style="color:var(--accent3)">Rp 15‚Äì30rb</td></tr>
          <tr><td>Resistor</td><td>510Œ©</td><td>K-Line pull-down</td><td style="color:var(--accent3)">Rp 500</td></tr>
          <tr><td>Resistor pull-up</td><td>10kŒ©</td><td>K-Line pull-up ke 12V</td><td style="color:var(--accent3)">Rp 500</td></tr>
          <tr><td>Diode</td><td>1N4148</td><td>Blocking (versi simple)</td><td style="color:var(--accent3)">Rp 500</td></tr>
          <tr><td>Konektor DLC</td><td>Sumitomo HM090 4P</td><td>Ke soket ECU</td><td style="color:var(--accent3)">Rp 10‚Äì20rb</td></tr>
          <tr><td>Kabel</td><td>22AWG</td><td>Wiring</td><td style="color:var(--accent3)">Rp 5rb</td></tr>
          <tr><td>PCB / Breadboard</td><td>‚Äî</td><td>Assembly</td><td style="color:var(--accent3)">Rp 5‚Äì15rb</td></tr>
        </tbody>
      </table>
      <div class="sep"></div>
      <div class="note ok">‚úì Total biaya hardware: <b>~Rp 70‚Äì130rb</b> vs Zeus MST-100P ~Rp 800rb‚Äì1.5jt</div>
      <div class="sep"></div>
      <div class="card-title">CATATAN PENTING</div>
      <div style="font-size:12px;line-height:2;color:var(--text2)">
        ‚Ä¢ K-Line adalah 12V bidirectional ‚Äî jangan hubungkan langsung ke Arduino 5V<br>
        ‚Ä¢ Selalu pakai L9637D untuk proteksi. Versi diode/resistor bisa tapi risiko lebih tinggi<br>
        ‚Ä¢ Pastikan GND laptop/PC terhubung ke GND ECU saat bench test<br>
        ‚Ä¢ Power supply 12V trainer harus stabil (bukan adaptor murahan)<br>
        ‚Ä¢ Terminal IG (ignition) harus dapat +12V sebelum ECU akan merespons
      </div>
    </div>
  </div>
</div>

</div><!-- /wrap -->

<script>
// ==================== STATE ====================
let port = null, reader = null, writer = null;
let connected = false;
let ecuModel = '';
let flashData = null;
let demoMode = false;
let demoTimer = null;
let liveLog = [];
let selectedFuelCell = null, selectedIgnCell = null;
let fuelMap = [], ignMap = [];
let oscHistory = { rpm:[], o2:[], tps:[], inj:[] };
const OSC_LEN = 100;

// ECU DB
const ECU_DB = {
  'K56-N01': { name:'Vario 150 / Sonic 150', chip:'Keihin R8C', flash:56*1024, initType:'C9', flashEnd:0xDFFF },
  'K45N-NA1': { name:'Vario 125', chip:'Keihin H8C', flash:48*1024, initType:'STD', flashEnd:0xBFFF },
  'K93-N01': { name:'Beat FI', chip:'Keihin H8C', flash:48*1024, initType:'STD', flashEnd:0xBFFF },
  'MKJ-D51': { name:'CBR 150', chip:'Keihin R8C', flash:56*1024, initType:'STD', flashEnd:0xDFFF },
  'KYJ-922': { name:'CBR 250', chip:'Keihin R8C', flash:56*1024, initType:'STD', flashEnd:0xDFFF },
};

// DTC DB
const DTC_DB = [
  { code:'P0107', desc:'MAP Sensor Low Voltage', sys:'MAP/BARO', sev:'active' },
  { code:'P0108', desc:'MAP Sensor High Voltage', sys:'MAP/BARO', sev:'active' },
  { code:'P0112', desc:'IAT Sensor Low Voltage', sys:'IAT', sev:'active' },
  { code:'P0113', desc:'IAT Sensor High Voltage', sys:'IAT', sev:'active' },
  { code:'P0116', desc:'ECT Sensor Range/Performance', sys:'ECT', sev:'active' },
  { code:'P0117', desc:'ECT Sensor Low Voltage', sys:'ECT', sev:'active' },
  { code:'P0118', desc:'ECT Sensor High Voltage', sys:'ECT', sev:'active' },
  { code:'P0122', desc:'TPS Sensor Low Voltage', sys:'TPS', sev:'active' },
  { code:'P0123', desc:'TPS Sensor High Voltage', sys:'TPS', sev:'active' },
  { code:'P0131', desc:'O2 Sensor Low Voltage (Bank 1)', sys:'O2', sev:'active' },
  { code:'P0132', desc:'O2 Sensor High Voltage (Bank 1)', sys:'O2', sev:'active' },
  { code:'P0336', desc:'CKP Sensor Range/Performance', sys:'CKP', sev:'active' },
  { code:'P0505', desc:'Idle Control System Malfunction', sys:'IACV', sev:'pending' },
  { code:'P1107', desc:'BARO Sensor Lower Than MAP', sys:'BARO', sev:'historic' },
  { code:'P1297', desc:'EPS/Elec Load Sensor', sys:'ELD', sev:'pending' },
];

// Remap params
const REMAP_PARAMS = [
  { id:'idle_rpm', label:'Idle RPM Target', min:700, max:2000, def:1000, step:50, unit:'rpm' },
  { id:'fuel_trim', label:'Fuel Trim Global', min:-30, max:30, def:0, step:1, unit:'%' },
  { id:'ign_adv', label:'Ignition Advance', min:-10, max:20, def:0, step:0.5, unit:'¬∞' },
  { id:'lambda', label:'Lambda Target', min:0.8, max:1.2, def:1.0, step:0.01, unit:'Œª' },
  { id:'rpm_lim', label:'RPM Limiter', min:6000, max:14000, def:11000, step:100, unit:'rpm' },
  { id:'spd_lim', label:'Speed Limiter', min:60, max:180, def:130, step:5, unit:'km/h' },
];

// K-Line CMD shortcuts
const CMDS = {
  INIT: 'INIT',
  WAKE: 'WAKE',
  TBL00: 'CMD:72 05 71 00 18',
  TBL10: 'CMD:72 05 71 10 08',
  TBL11: 'CMD:72 05 71 11 07',
  TBL60: 'CMD:72 05 71 60 B8',
  RDTC:  'CMD:72 05 73 00 16',
  CLRDTC:'CMD:72 05 74 00 15',
  KEEPALIVE:'CMD:72 05 72 00 00 8E',
  FLASHRD:'FLASHRD',
};

// Memory map regions
const MEM_MAP = [
  { addr:'0x0000', label:'BOOTLOADER (READ ONLY)', size:'4 KB', color:'#ff224455', pct:7 },
  { addr:'0x1000', label:'CALIBRATION DATA', size:'8 KB', color:'#ffcc0055', pct:14 },
  { addr:'0x3000', label:'FUEL MAP (RPM√ókPa)', size:'2 KB', color:'#00e5ff66', pct:4 },
  { addr:'0x3800', label:'FUEL MAP (RPM√óTPS)', size:'2 KB', color:'#00e5ff44', pct:4 },
  { addr:'0x4000', label:'IGNITION MAP (RPM√ókPa)', size:'2 KB', color:'#39ff1466', pct:4 },
  { addr:'0x4800', label:'IGNITION MAP (RPM√óTPS)', size:'2 KB', color:'#39ff1444', pct:4 },
  { addr:'0x5000', label:'IDLE CONTROL TABLE', size:'512 B', color:'#ff6b3555', pct:1 },
  { addr:'0x5200', label:'COLD START ENRICHMENT', size:'256 B', color:'#aa44ff55', pct:1 },
  { addr:'0x6000', label:'RPM LIMITER TABLE', size:'64 B', color:'#ff224455', pct:1 },
  { addr:'0x6100', label:'SPEED LIMITER TABLE', size:'64 B', color:'#ff6b3555', pct:1 },
  { addr:'0x7000', label:'FIRMWARE CODE', size:'~28 KB', color:'#607080aa', pct:59 },
];

// Arduino firmware source
const FIRMWARE = `/* ============================================
   DIY ECU TOOL ‚Äî Arduino K-Line Bridge
   Hardware: Arduino UNO / Nano (ATmega328P)
   Protokol: Honda K-Line ISO 9141 (10400 baud)
   Browser ‚Üí Arduino: CMD:HEX_BYTES\\n or INIT/WAKE/etc
   Arduino ‚Üí Browser: RX:HEX_BYTES\\n / STATUS:text\\n
   ============================================ */

#include <SoftwareSerial.h>

#define KLINE_TX_PIN  2   // K-Line TX (via 510Œ© + L9637D)
#define KLINE_RX_PIN  3   // K-Line RX
#define KLINE_BAUD    10400
#define PC_BAUD       115200
#define KEEPALIVE_MS  2000

SoftwareSerial kline(KLINE_RX_PIN, KLINE_TX_PIN);

unsigned long lastKeepAlive = 0;
bool ecuConnected = false;
String inputBuf = "";

// K-Line slow init sequence
void klineInit() {
  // Step 1: Pull LOW 70ms (break signal)
  pinMode(KLINE_TX_PIN, OUTPUT);
  digitalWrite(KLINE_TX_PIN, LOW);
  delay(70);

  // Step 2: HIGH 120ms
  digitalWrite(KLINE_TX_PIN, HIGH);
  delay(120);

  // Step 3: Start SoftwareSerial at 10400 baud
  kline.begin(KLINE_BAUD);

  Serial.println("STATUS:K-Line init pulse done");
  delay(20);
}

// K-Line C9 series init (K56-N01)
void klineInitC9() {
  // C9 prefix before wake
  byte prefix[] = {0xBF, 0x00, 0x04, 0x04, 0xFE};
  pinMode(KLINE_TX_PIN, OUTPUT);
  digitalWrite(KLINE_TX_PIN, LOW);
  delay(200);
  digitalWrite(KLINE_TX_PIN, HIGH);
  delay(200);
  kline.begin(KLINE_BAUD);
  for(int i=0; i<5; i++) kline.write(prefix[i]);
  delay(50);
  Serial.println("STATUS:C9 prefix sent");
}

// Send wake frame
void sendWake() {
  byte wake[] = {0xFE, 0x04, 0xFF, 0xFF};
  for(int i=0; i<4; i++) kline.write(wake[i]);
  delay(200);
  Serial.println("STATUS:Wake sent");
}

// Send init request
void sendInitReq() {
  byte init[] = {0x72, 0x05, 0x00, 0xF0, 0x99, 0xF0};
  for(int i=0; i<6; i++) kline.write(init[i]);
  Serial.println("STATUS:Init request sent");
}

// Calculate Honda K-Line checksum
byte calcCS(byte *buf, int len) {
  int sum = 0;
  for(int i=0; i<len; i++) sum += buf[i];
  return (0x100 - (sum & 0xFF)) & 0xFF;
}

// Send hex bytes array to K-Line
void sendHex(byte *buf, int len) {
  for(int i=0; i<len; i++) kline.write(buf[i]);
}

// Send keepalive
void sendKeepalive() {
  byte ka[] = {0x72, 0x05, 0x72, 0x00, 0x00, 0x8E};
  sendHex(ka, 6);
}

// Parse and send hex string from PC
void parseSendHex(String hexStr) {
  hexStr.trim();
  byte buf[64];
  int len = 0;
  int pos = 0;
  while(pos < hexStr.length() && len < 64) {
    while(pos < hexStr.length() && hexStr[pos]==' ') pos++;
    if(pos+1 >= hexStr.length()) break;
    String byteStr = hexStr.substring(pos, pos+2);
    buf[len++] = (byte)strtol(byteStr.c_str(), NULL, 16);
    pos += 2;
  }
  sendHex(buf, len);
}

// Read response from K-Line with timeout
String readKLineResponse(int timeout_ms) {
  String resp = "RX:";
  unsigned long t = millis();
  while(millis()-t < timeout_ms) {
    if(kline.available()) {
      byte b = kline.read();
      char hex[4];
      sprintf(hex, "%02X ", b);
      resp += hex;
      t = millis(); // reset timeout on data
    }
  }
  return resp;
}

void setup() {
  Serial.begin(PC_BAUD);
  Serial.println("STATUS:DIY ECU Bridge ready. Send INIT to begin.");
  pinMode(KLINE_TX_PIN, OUTPUT);
  digitalWrite(KLINE_TX_PIN, HIGH);
}

void loop() {
  // Read from PC (browser)
  while(Serial.available()) {
    char c = Serial.read();
    if(c == '\\n') {
      processCommand(inputBuf);
      inputBuf = "";
    } else {
      inputBuf += c;
    }
  }

  // Forward K-Line data to PC
  if(kline.available()) {
    String resp = readKLineResponse(50);
    if(resp.length() > 3) {
      Serial.println(resp);
    }
  }

  // Keepalive
  if(ecuConnected && millis()-lastKeepAlive > KEEPALIVE_MS) {
    sendKeepalive();
    lastKeepAlive = millis();
  }
}

void processCommand(String cmd) {
  cmd.trim();

  if(cmd == "INIT") {
    klineInit();
    delay(100);
    sendWake();
    delay(200);
    sendInitReq();
    String resp = readKLineResponse(300);
    Serial.println(resp);
    if(resp.length() > 3) {
      ecuConnected = true;
      Serial.println("STATUS:ECU connected");
    } else {
      Serial.println("ERR:No ECU response. Check wiring & IG power.");
    }
  }
  else if(cmd == "INITC9") {
    klineInitC9();
    delay(100);
    sendWake();
    delay(200);
    sendInitReq();
    String resp = readKLineResponse(300);
    Serial.println(resp);
    if(resp.length() > 3) {
      ecuConnected = true;
      Serial.println("STATUS:ECU (C9 series) connected");
    } else {
      Serial.println("ERR:No response (C9). Check IG power & DLC.");
    }
  }
  else if(cmd == "WAKE") {
    sendWake();
    Serial.println("STATUS:Wake sent");
  }
  else if(cmd == "FLASHRD") {
    // Flash read command ‚Äî browser handles framing
    Serial.println("STATUS:Ready for flash read frames");
  }
  else if(cmd.startsWith("CMD:")) {
    String hexPart = cmd.substring(4);
    parseSendHex(hexPart);
    String resp = readKLineResponse(150);
    if(resp.length() > 3) Serial.println(resp);
    lastKeepAlive = millis();
  }
  else if(cmd == "STATUS") {
    Serial.println(ecuConnected ? "STATUS:connected" : "STATUS:offline");
  }
  else {
    Serial.println("ERR:Unknown command: " + cmd);
  }
}`;

// ==================== INIT ====================
window.onload = () => {
  buildFuelMap();
  buildIgnMap();
  buildParamRows();
  buildDtcRef();
  buildMemMap();
  renderFirmware();
  startOscCanvas();
};

// ==================== TABS ====================
function showTab(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('panel-'+name).classList.add('active');
  document.getElementById('tab-'+name).classList.add('active');
}

// ==================== SERIAL ====================
async function connectSerial() {
  if (!('serial' in navigator)) {
    termLog('[ERR] Web Serial API tidak tersedia. Gunakan Chrome 89+.', 't-err');
    return;
  }
  if (!ecuModel) { alert('Pilih ECU terlebih dahulu!'); return; }
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });
    connected = true;
    writer = port.writable.getWriter();
    reader = port.readable.getReader();
    updateStatus('ONLINE', 'online');
    document.getElementById('pillPort').textContent = 'PORT: COM';
    document.getElementById('btnConnect').disabled = true;
    document.getElementById('btnDisconnect').disabled = false;
    termLog('[SYS] Port terbuka. Menginisialisasi ECU...', 't-sys');
    readLoop();
    // Send INIT
    const initCmd = (ecuModel === 'K56-N01') ? 'INITC9' : 'INIT';
    await writeSerial(initCmd + '\n');
    // Start live polling
    startLivePolling();
  } catch(e) {
    termLog('[ERR] ' + e.message, 't-err');
  }
}

async function disconnectSerial() {
  connected = false;
  demoMode = false;
  if (demoTimer) clearInterval(demoTimer);
  try {
    if (reader) { await reader.cancel(); reader = null; }
    if (writer) { writer.releaseLock(); writer = null; }
    if (port) { await port.close(); port = null; }
  } catch(e) {}
  updateStatus('OFFLINE', 'danger');
  document.getElementById('pillPort').textContent = 'PORT: ‚Äî';
  document.getElementById('btnConnect').disabled = false;
  document.getElementById('btnDisconnect').disabled = true;
  document.getElementById('liveTag').textContent = '‚óè OFFLINE';
  document.getElementById('liveTag').style.color = 'var(--danger)';
  termLog('[SYS] Disconnected.', 't-sys');
}

async function writeSerial(str) {
  if (!writer) return;
  const enc = new TextEncoder();
  await writer.write(enc.encode(str));
}

async function readLoop() {
  const dec = new TextDecoder();
  let buf = '';
  try {
    while (connected && reader) {
      const { value, done } = await reader.read();
      if (done) break;
      buf += dec.decode(value);
      let lines = buf.split('\n');
      buf = lines.pop();
      for (const line of lines) parseArduinoLine(line.trim());
    }
  } catch(e) { if(connected) termLog('[ERR] Read: '+e.message,'t-err'); }
}

function parseArduinoLine(line) {
  if (!line) return;
  if (line.startsWith('RX:')) {
    termLog('[RX] ' + line.substring(3), 't-rx');
    const bytes = line.substring(3).trim().split(' ').filter(Boolean).map(h => parseInt(h,16));
    parseEcuResponse(bytes);
  } else if (line.startsWith('STATUS:')) {
    termLog('[SYS] ' + line.substring(7), 't-sys');
    if (line.includes('connected')) {
      updateStatus('ONLINE', 'online');
      document.getElementById('liveTag').textContent = '‚óè LIVE';
      document.getElementById('liveTag').style.color = 'var(--accent3)';
    }
  } else if (line.startsWith('ERR:')) {
    termLog('[ERR] ' + line.substring(4), 't-err');
  } else {
    termLog('[?] ' + line, 't-sys');
  }
}

// ==================== DEMO MODE ====================
function sendDemo() {
  demoMode = true;
  connected = true;
  updateStatus('DEMO', 'warn');
  document.getElementById('liveTag').textContent = '‚óè DEMO';
  document.getElementById('liveTag').style.color = 'var(--warn)';
  termLog('[SYS] Demo mode aktif ‚Äî data simulasi.', 't-warn');
  startLivePolling();
}

let demoT = 0;
function genDemoData() {
  demoT += 0.04;
  const rpm = Math.round(1200 + Math.sin(demoT*0.7)*400 + Math.sin(demoT*2.1)*200);
  const spd = Math.round(rpm * 0.015 + Math.sin(demoT*0.5)*5);
  const tps = Math.max(0, Math.min(100, 20 + Math.sin(demoT*1.2)*15));
  const ect = Math.round(82 + Math.sin(demoT*0.05)*5);
  const iat = Math.round(35 + Math.sin(demoT*0.03)*3);
  const map_ = Math.round(60 + Math.sin(demoT*1.5)*20);
  const o2 = (0.45 + Math.sin(demoT*3)*0.25).toFixed(3);
  const bat = (12.4 + Math.sin(demoT*0.1)*0.3).toFixed(1);
  const inj = (2.5 + Math.sin(demoT*0.8)*0.5).toFixed(2);
  const ign = Math.round(15 + Math.sin(demoT*0.9)*5);
  const stft = (Math.sin(demoT*2.5)*4).toFixed(1);
  const ltft = (Math.sin(demoT*0.1)*2).toFixed(1);
  updateLiveData({rpm,spd,tps,ect,iat,map:map_,o2,bat,inj,ign,stft,ltft});
}

// ==================== LIVE POLLING ====================
let pollTimer = null;
function startLivePolling() {
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async () => {
    if (!connected) { clearInterval(pollTimer); return; }
    if (demoMode) { genDemoData(); return; }
    // Real: request table 00 & 10 alternating
    await writeSerial('CMD:72 05 71 00 18\n');
  }, 250);
  // Also poll table 10 & 11
  setInterval(async () => {
    if (!connected || demoMode) return;
    await writeSerial('CMD:72 05 71 10 08\n');
  }, 500);
}

// ==================== ECU RESPONSE PARSER ====================
function parseEcuResponse(bytes) {
  if (bytes.length < 4) return;
  if (bytes[0] === 0x02) {
    const table = bytes[2];
    const data = bytes.slice(4, -1);
    if (table === 0x00 || table === 0x71) {
      // Table 00: RPM B0B1, Speed B3, TPS B5, Bat B7
      if (data.length >= 8) {
        const rpm = ((data[0]<<8)|data[1]) * 0.25;
        const spd = data[3];
        const tps = (data[5]*100/255).toFixed(1);
        const bat = (data[7]*18/255).toFixed(1);
        updateLivePartial({rpm:Math.round(rpm),spd,tps,bat});
      }
    } else if (table === 0x10) {
      if (data.length >= 4) {
        const ect = data[0]-40;
        const iat = data[1]-40;
        const map_ = data[2];
        const o2 = (data[3]*5/255).toFixed(3);
        updateLivePartial({ect,iat,map:map_,o2});
      }
    } else if (table === 0x11) {
      if (data.length >= 4) {
        const inj = (data[0]*0.256).toFixed(2);
        const ign = (data[1]/2-64).toFixed(1);
        const stft = ((data[2]-128)*100/128).toFixed(1);
        const ltft = ((data[3]-128)*100/128).toFixed(1);
        updateLivePartial({inj,ign,stft,ltft});
      }
    }
  }
}

// ==================== LIVE DATA UPDATE ====================
let liveState = {};
function updateLivePartial(d) {
  Object.assign(liveState, d);
  updateLiveData(liveState);
}

function updateLiveData(d) {
  if (d.rpm !== undefined) {
    const r = Math.round(d.rpm);
    set('g-rpm', r); set('v-rpm', r+' rpm'); set('r-rpm', '0x'+(r*4).toString(16).toUpperCase());
    pct('b-rpm', r/12000*100);
    colorGauge('g-rpm', r > 10000 ? 'danger' : r > 8000 ? 'warn' : '');
  }
  if (d.spd !== undefined) { set('g-spd', d.spd); set('v-spd', d.spd+' km/h'); set('r-spd', d.spd); pct('b-spd', d.spd/180*100); }
  if (d.tps !== undefined) { set('g-tps', parseFloat(d.tps).toFixed(0)); set('v-tps', d.tps+' %'); set('r-tps', Math.round(d.tps*255/100)); pct('b-tps', d.tps); }
  if (d.ect !== undefined) { set('g-ect', d.ect); set('v-ect', d.ect+' ¬∞C'); set('r-ect', parseInt(d.ect)+40); pct('b-ect', (d.ect+20)/120*100); colorGauge('g-ect', d.ect>100?'danger':d.ect>90?'warn':''); }
  if (d.iat !== undefined) { set('v-iat', d.iat+' ¬∞C'); set('r-iat', parseInt(d.iat)+40); }
  if (d.map !== undefined) { set('g-map', d.map); set('v-map', d.map+' kPa'); set('r-map', d.map); pct('b-map', d.map/115*100); }
  if (d.o2 !== undefined) { set('g-o2', d.o2); set('v-o2', d.o2+' V'); set('r-o2', Math.round(d.o2*255/5)); pct('b-o2', d.o2/1*100); }
  if (d.bat !== undefined) { set('v-bat', d.bat+' V'); set('r-bat', d.bat); }
  if (d.inj !== undefined) { set('v-inj', d.inj+' ms'); set('r-inj', d.inj); }
  if (d.ign !== undefined) { set('v-ign', d.ign+' ¬∞'); set('r-ign', d.ign); }
  if (d.stft !== undefined) { set('v-stft', d.stft+' %'); set('r-stft', Math.round(parseFloat(d.stft)*128/100+128)); }
  if (d.ltft !== undefined) { set('v-ltft', d.ltft+' %'); set('r-ltft', d.ltft); }
  // osc history
  if (d.rpm !== undefined) pushOsc('rpm', d.rpm/12000);
  if (d.o2 !== undefined) pushOsc('o2', d.o2);
  if (d.tps !== undefined) pushOsc('tps', d.tps/100);
  if (d.inj !== undefined) pushOsc('inj', d.inj/10);
  liveLog.push({t: Date.now(), ...d});
  if (liveLog.length > 5000) liveLog.shift();
}

function set(id, val) { const e = document.getElementById(id); if(e) e.textContent = val; }
function pct(id, v) { const e = document.getElementById(id); if(e) { e.style.width = Math.min(100,Math.max(0,v))+'%'; } }
function colorGauge(id, cls) { const e = document.getElementById(id); if(!e) return; e.className = 'gauge-val'+(cls?' '+cls:''); }

// ==================== OSCILLOSCOPE ====================
function pushOsc(ch, val) {
  oscHistory[ch].push(val);
  if (oscHistory[ch].length > OSC_LEN) oscHistory[ch].shift();
}

function startOscCanvas() {
  const canvas = document.getElementById('oscCanvas');
  const ctx = canvas.getContext('2d');
  function draw() {
    const W = canvas.offsetWidth; const H = 180;
    canvas.width = W; canvas.height = H;
    ctx.fillStyle = '#020508'; ctx.fillRect(0,0,W,H);
    // Grid
    ctx.strokeStyle = '#0d1825'; ctx.lineWidth = 1;
    for(let y=0;y<H;y+=30){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
    for(let x=0;x<W;x+=50){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
    const colors = { rpm:'#00e5ff', o2:'#ff6b35', tps:'#39ff14', inj:'#ffcc00' };
    for(const [ch, color] of Object.entries(colors)) {
      const data = oscHistory[ch];
      if (!data.length) continue;
      ctx.strokeStyle = color; ctx.lineWidth = 1.5;
      ctx.beginPath();
      for(let i=0;i<data.length;i++) {
        const x = (i/OSC_LEN)*W;
        const y = H - data[i]*H*0.85 - 5;
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      }
      ctx.stroke();
    }
    requestAnimationFrame(draw);
  }
  draw();
}

// ==================== CMD ====================
async function sendCmd(name) {
  const cmd = CMDS[name];
  if (!cmd) return;
  termLog('[TX] ' + cmd, 't-tx');
  if (connected && !demoMode) await writeSerial(cmd + '\n');
}

async function sendRaw() {
  const v = document.getElementById('termInput').value.trim();
  if (!v) return;
  const cmd = 'CMD:' + v.toUpperCase();
  termLog('[TX] ' + cmd, 't-tx');
  if (connected && !demoMode) await writeSerial(cmd + '\n');
  document.getElementById('termInput').value = '';
}

function termLog(msg, cls='t-sys') {
  const t = document.getElementById('terminal');
  const line = document.createElement('div');
  line.className = cls;
  line.textContent = msg;
  t.appendChild(line);
  t.scrollTop = t.scrollHeight;
}

function clearTerm() { document.getElementById('terminal').innerHTML = ''; }

// ==================== ECU SELECT ====================
function onEcuChange() {
  ecuModel = document.getElementById('ecuSelect').value;
  const info = ECU_DB[ecuModel];
  document.getElementById('pillEcu').textContent = ecuModel ? 'ECU: '+ecuModel : 'ECU: ‚Äî';
  if (info) termLog('[SYS] ECU dipilih: '+info.name+' ('+info.chip+')', 't-sys');
}

function updateStatus(txt, cls) {
  const el = document.getElementById('pillStatus');
  el.textContent = txt;
  el.className = 'pill ' + cls;
}

// ==================== FLASH ====================
let flashReadData = null;

async function flashRead() {
  if (!connected && !demoMode) { alert('Tidak terkoneksi!'); return; }
  const info = ECU_DB[ecuModel];
  if (!info) { alert('Pilih ECU!'); return; }
  const totalSize = info.flash;
  flashReadData = new Uint8Array(totalSize).fill(0xFF);
  document.getElementById('flashStatus').textContent = 'Reading flash...';
  document.getElementById('btnFlashRead').disabled = true;
  const CHUNK = 128;
  const totalChunks = Math.ceil(totalSize / CHUNK);
  for (let i = 0; i < totalChunks; i++) {
    const addr = i * CHUNK;
    const len = Math.min(CHUNK, totalSize - addr);
    pct('flashProg', (i+1)/totalChunks*100);
    document.getElementById('flashStatus').textContent = `Reading: 0x${addr.toString(16).toUpperCase().padStart(4,'0')} (${Math.round((i+1)/totalChunks*100)}%)`;
    if (demoMode) {
      // Simulate read
      for (let b = 0; b < len; b++) {
        flashReadData[addr+b] = Math.round(Math.random()*255);
      }
      await new Promise(r => setTimeout(r, 1));
    } else {
      const addrH = (addr>>8)&0xFF, addrL = addr&0xFF;
      const csBody = [0x72,0x07,0x76,addrH,addrL,len];
      const cs = calcCS(csBody);
      const hexStr = csBody.map(b=>b.toString(16).padStart(2,'0').toUpperCase()).join(' ') + ' ' + cs.toString(16).padStart(2,'0').toUpperCase();
      await writeSerial('CMD:' + hexStr + '\n');
      await new Promise(r => setTimeout(r, 80));
    }
  }
  document.getElementById('flashStatus').textContent = `Flash read complete! ${totalSize} bytes.`;
  document.getElementById('btnFlashRead').disabled = false;
  document.getElementById('btnSaveFlash').disabled = false;
  document.getElementById('btnWrite').disabled = false;
  document.getElementById('btnVerify').disabled = false;
  flashData = flashReadData;
  renderHexDisplay();
  updateFlashInfo();
}

function renderHexDisplay() {
  if (!flashData) return;
  let html = '';
  const showBytes = Math.min(flashData.length, 512);
  for (let i = 0; i < showBytes; i += 16) {
    const addrStr = i.toString(16).toUpperCase().padStart(4,'0');
    let row = `<span class="addr">${addrStr}:</span>  `;
    for (let j = i; j < Math.min(i+16, showBytes); j++) {
      const b = flashData[j];
      const hex = b.toString(16).toUpperCase().padStart(2,'0');
      const cls = b===0 ? 'zero' : b===0xFF ? 'addr' : '';
      row += `<span class="${cls}">${hex}</span> `;
    }
    html += row + '\n';
  }
  html += `<span class="addr">... (${flashData.length} bytes total)</span>`;
  document.getElementById('hexDisplay').innerHTML = html;
}

function saveFlash() {
  if (!flashData) return;
  const blob = new Blob([flashData], {type:'application/octet-stream'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (ecuModel||'ecu') + '_backup.bin';
  a.click();
}

function loadFlash() { document.getElementById('fileInput').click(); }

function onFileLoad(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    flashData = new Uint8Array(ev.target.result);
    document.getElementById('btnWrite').disabled = false;
    document.getElementById('btnVerify').disabled = false;
    document.getElementById('btnSaveFlash').disabled = false;
    renderHexDisplay();
    updateFlashInfo();
    document.getElementById('writeStatus').textContent = `Loaded: ${file.name} (${flashData.length} bytes)`;
  };
  reader.readAsArrayBuffer(file);
}

function updateFlashInfo() {
  if (!flashData) return;
  let cs = 0; for(const b of flashData) cs = (cs+b)&0xFFFF;
  document.getElementById('flashInfo').textContent = `Size: ${flashData.length} bytes ¬∑ Checksum: 0x${cs.toString(16).toUpperCase().padStart(4,'0')}`;
}

async function flashWrite() {
  if (!flashData) { alert('Load .bin terlebih dahulu!'); return; }
  if (!confirm('‚ö† WRITE FLASH ke ECU? Pastikan power stabil dan ini ECU trainer!')) return;
  const CHUNK = 128;
  const total = flashData.length;
  document.getElementById('writeStatus').textContent = 'Writing...';
  for(let i=0;i<total;i+=CHUNK) {
    const addr = i;
    const chunk = flashData.slice(i, Math.min(i+CHUNK, total));
    pct('writeProg', (i+CHUNK)/total*100);
    document.getElementById('writeStatus').textContent = `Writing: 0x${addr.toString(16).toUpperCase().padStart(4,'0')} (${Math.round((i+CHUNK)/total*100)}%)`;
    if (!demoMode) {
      // Build write command
      const addrH = (addr>>8)&0xFF, addrL = addr&0xFF;
      let cmd = [0x72, 2+chunk.length+4, 0x77, addrH, addrL];
      cmd = cmd.concat(Array.from(chunk));
      const cs = calcCS(cmd);
      cmd.push(cs);
      const hexStr = cmd.map(b=>b.toString(16).padStart(2,'0').toUpperCase()).join(' ');
      await writeSerial('CMD:' + hexStr + '\n');
      await new Promise(r=>setTimeout(r,100));
    } else {
      await new Promise(r=>setTimeout(r,2));
    }
  }
  document.getElementById('writeStatus').textContent = 'Write complete!';
}

async function flashVerify() {
  document.getElementById('writeStatus').textContent = 'Verifying...';
  await new Promise(r=>setTimeout(r,1000));
  document.getElementById('writeStatus').textContent = demoMode ? 'Verify OK (demo)' : 'Verify: Read back and compare...';
}

function readTable() {
  if (!connected && !demoMode) { alert('Tidak terkoneksi!'); return; }
  sendCmd('TBL00');
}

function calcCS(bytes) {
  let s = bytes.reduce((a,b)=>a+b,0);
  return (0x100 - (s&0xFF)) & 0xFF;
}

// ==================== MEMORY MAP ====================
function buildMemMap() {
  const el = document.getElementById('memmap');
  let html = '';
  for(const r of MEM_MAP) {
    html += `<div class="memmap-row">
      <span class="memmap-addr">${r.addr}</span>
      <div class="memmap-bar"><div class="memmap-fill" style="width:${r.pct}%;background:${r.color}"></div></div>
      <span class="memmap-label">${r.label}</span>
      <span class="memmap-size">${r.size}</span>
    </div>`;
  }
  el.innerHTML = html;
}

// ==================== REMAP MAPS ====================
const RPM_AXIS = [500,1000,1500,2000,2500,3000,4000,5000,6000,7000,8000,9000,10000,11000,12000,13000];
const KPA_AXIS = [20,30,40,50,60,70,80,90,100,110,115,120];

function buildFuelMap() {
  fuelMap = RPM_AXIS.map(() => KPA_AXIS.map(() => 128 + Math.round((Math.random()-0.5)*10)));
  renderMap('fuelMapWrap', fuelMap, 'fuel');
}

function buildIgnMap() {
  ignMap = RPM_AXIS.map(() => KPA_AXIS.map(() => 148 + Math.round((Math.random()-0.5)*8)));
  renderMap('ignMapWrap', ignMap, 'ign');
}

function mapColor(v, mapType) {
  if (mapType === 'fuel') {
    const norm = (v-80)/(180-80);
    const r = Math.round(norm*220);
    const b = Math.round((1-norm)*220);
    return `rgb(${r},${Math.round(40+norm*20)},${b})`;
  } else {
    const deg = v/2-64;
    const norm = (deg+10)/40;
    const r = Math.round(norm*200);
    const g = Math.round((1-Math.abs(norm-0.5))*180);
    return `rgb(${r},${g},30)`;
  }
}

function renderMap(containerId, data, mapType) {
  const sel = mapType==='fuel' ? selectedFuelCell : selectedIgnCell;
  let html = '<table class="map-table"><thead><tr><th>RPM‚Üì kPa‚Üí</th>';
  for(const k of KPA_AXIS) html += `<th>${k}</th>`;
  html += '</tr></thead><tbody>';
  for(let r=0; r<RPM_AXIS.length; r++) {
    html += `<tr><th style="padding:0 8px;color:var(--accent2);background:var(--bg3);font-family:'Share Tech Mono';font-size:10px">${RPM_AXIS[r]}</th>`;
    for(let c=0; c<KPA_AXIS.length; c++) {
      const v = data[r][c];
      const color = mapColor(v, mapType);
      const brightness = v > 128 ? '#fff' : '#ccc';
      const selCls = (sel && sel[0]===r && sel[1]===c) ? ' selected' : '';
      html += `<td style="background:${color};color:${brightness}" class="${selCls}" onclick="selectCell('${mapType}',${r},${c})">
        <input class="map-cell-input" style="color:${brightness}" value="${v}" onchange="cellChange('${mapType}',${r},${c},this.value)" onfocus="selectCell('${mapType}',${r},${c})">
      </td>`;
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  document.getElementById(containerId).innerHTML = html;
}

function selectCell(type, r, c) {
  if(type==='fuel') { selectedFuelCell=[r,c]; document.getElementById('fuelSel').textContent=`RPM:${RPM_AXIS[r]} kPa:${KPA_AXIS[c]} = ${fuelMap[r][c]}`; document.getElementById('fuelVal').value=fuelMap[r][c]; }
  else { selectedIgnCell=[r,c]; document.getElementById('ignSel').textContent=`RPM:${RPM_AXIS[r]} kPa:${KPA_AXIS[c]} = ${ignMap[r][c]} (${(ignMap[r][c]/2-64).toFixed(1)}¬∞)`; document.getElementById('ignVal').value=ignMap[r][c]; }
  renderMap(type==='fuel'?'fuelMapWrap':'ignMapWrap', type==='fuel'?fuelMap:ignMap, type);
}

function cellChange(type, r, c, v) {
  const val = Math.max(0, Math.min(255, parseInt(v)||0));
  if(type==='fuel') fuelMap[r][c]=val;
  else ignMap[r][c]=val;
}

function setFuelCell() {
  if(!selectedFuelCell) return;
  const v = parseInt(document.getElementById('fuelVal').value);
  fuelMap[selectedFuelCell[0]][selectedFuelCell[1]] = Math.max(0,Math.min(255,v));
  renderMap('fuelMapWrap', fuelMap, 'fuel');
}

function setIgnCell() {
  if(!selectedIgnCell) return;
  const v = parseInt(document.getElementById('ignVal').value);
  ignMap[selectedIgnCell[0]][selectedIgnCell[1]] = Math.max(0,Math.min(255,v));
  renderMap('ignMapWrap', ignMap, 'ign');
}

function globalTrim(type) {
  const pct = parseFloat(type==='fuel' ? document.getElementById('fuelTrimPct').value : document.getElementById('ignTrimDeg').value);
  const map = type==='fuel' ? fuelMap : ignMap;
  for(let r=0;r<map.length;r++) for(let c=0;c<map[r].length;c++) {
    if(type==='fuel') map[r][c] = Math.max(0,Math.min(255,Math.round(map[r][c]*(1+pct/100))));
    else map[r][c] = Math.max(0,Math.min(255,Math.round(map[r][c]+pct*2)));
  }
  renderMap(type==='fuel'?'fuelMapWrap':'ignMapWrap', map, type);
}

// ==================== REMAP PARAMS ====================
function buildParamRows() {
  const el = document.getElementById('paramRows');
  let html = '';
  for(const p of REMAP_PARAMS) {
    html += `<div class="param-row">
      <span class="param-label">${p.label}</span>
      <input class="param-input" id="pr-${p.id}" type="number" min="${p.min}" max="${p.max}" step="${p.step}" value="${p.def}" onchange="syncRange('${p.id}')">
      <span class="param-unit">${p.unit}</span>
      <div class="param-range"><input type="range" id="prr-${p.id}" min="${p.min}" max="${p.max}" step="${p.step}" value="${p.def}" oninput="syncInput('${p.id}')"></div>
    </div>`;
  }
  el.innerHTML = html;
}

function syncRange(id) { const v=document.getElementById('pr-'+id).value; document.getElementById('prr-'+id).value=v; }
function syncInput(id) { const v=document.getElementById('prr-'+id).value; document.getElementById('pr-'+id).value=v; }

async function applyRemap() {
  if (!connected && !demoMode) { alert('Tidak terkoneksi!'); return; }
  const queue = [];
  for(const p of REMAP_PARAMS) {
    const v = parseFloat(document.getElementById('pr-'+p.id).value);
    queue.push(p.id + '=' + v + p.unit);
  }
  document.getElementById('remapQueue').textContent = 'Applying: ' + queue.join(', ');
  termLog('[SYS] Applying remap params...', 't-warn');
  await new Promise(r=>setTimeout(r,500));
  document.getElementById('remapQueue').textContent = 'Queue: ' + (demoMode ? 'Demo applied OK' : 'Sent to ECU');
  termLog('[SYS] Remap applied.', 't-sys');
}

function resetRemap() {
  for(const p of REMAP_PARAMS) {
    document.getElementById('pr-'+p.id).value = p.def;
    document.getElementById('prr-'+p.id).value = p.def;
  }
  document.getElementById('remapQueue').textContent = 'Queue: reset to stock';
}

function saveProfile() {
  const profile = {};
  for(const p of REMAP_PARAMS) profile[p.id] = parseFloat(document.getElementById('pr-'+p.id).value);
  profile.fuelMap = fuelMap;
  profile.ignMap = ignMap;
  profile.ecu = ecuModel;
  profile.saved = new Date().toISOString();
  const blob = new Blob([JSON.stringify(profile,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (ecuModel||'ecu') + '_remap_' + Date.now() + '.json';
  a.click();
}

function loadProfile() { document.getElementById('profileInput').click(); }
function onProfileLoad(e) {
  const file = e.target.files[0];
  if (!file) return;
  const fr = new FileReader();
  fr.onload = ev => {
    try {
      const p = JSON.parse(ev.target.result);
      for(const param of REMAP_PARAMS) {
        if(p[param.id] !== undefined) {
          document.getElementById('pr-'+param.id).value = p[param.id];
          document.getElementById('prr-'+param.id).value = p[param.id];
        }
      }
      if(p.fuelMap) { fuelMap = p.fuelMap; renderMap('fuelMapWrap', fuelMap, 'fuel'); }
      if(p.ignMap) { ignMap = p.ignMap; renderMap('ignMapWrap', ignMap, 'ign'); }
      termLog('[SYS] Profile loaded: ' + file.name, 't-sys');
    } catch(err) { alert('Error: invalid profile JSON'); }
  };
  fr.readAsText(file);
}

// ==================== DTC ====================
function buildDtcRef() {
  const tb = document.getElementById('dtcRefTable');
  let html = '<thead><tr><th>CODE</th><th>DESCRIPTION</th><th>SYSTEM</th></tr></thead><tbody>';
  for(const d of DTC_DB) html += `<tr><td class="val-cell">${d.code}</td><td>${d.desc}</td><td style="color:var(--text2)">${d.sys}</td></tr>`;
  html += '</tbody>';
  tb.innerHTML = html;
}

function clearDtc() {
  sendCmd('CLRDTC');
  document.getElementById('dtcList').innerHTML = '<div style="color:var(--accent3);font-family:\'Share Tech Mono\';font-size:12px;padding:12px 0">DTC cleared.</div>';
}

function readFreezeFrame() {
  termLog('[SYS] Freeze frame requested (Table 0x76)...', 't-sys');
  if(connected && !demoMode) writeSerial('CMD:72 05 73 01 15\n');
}

// Simulate DTC read in demo
function simulateDtcRead() {
  const active = [DTC_DB[0], DTC_DB[6]];
  let html = '';
  for(const d of active) {
    html += `<div class="dtc-item ${d.sev}">
      <span class="dtc-code">${d.code}</span>
      <span class="dtc-desc">${d.desc}</span>
      <span class="dtc-status">${d.sev.toUpperCase()}</span>
    </div>`;
  }
  document.getElementById('dtcList').innerHTML = html;
}
// Override sendCmd for demo DTC
const _origSendCmd = sendCmd;

// ==================== CSV EXPORT ====================
function exportCSV() {
  if (!liveLog.length) { alert('Tidak ada data live!'); return; }
  const keys = ['t','rpm','spd','tps','ect','iat','map','o2','bat','inj','ign','stft','ltft'];
  let csv = keys.join(',') + '\n';
  for(const row of liveLog) csv += keys.map(k => row[k]??'').join(',') + '\n';
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'live_data_' + Date.now() + '.csv';
  a.click();
}

// ==================== FIRMWARE RENDER ====================
function renderFirmware() {
  // Simple syntax highlight
  let code = FIRMWARE;
  code = code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  // comments
  code = code.replace(/(\/\*[\s\S]*?\*\/|\/\/[^\n]*)/g, '<span class="cm">$1</span>');
  // strings
  code = code.replace(/"([^"\\]|\\.)*"/g, '<span class="str">$&</span>');
  // keywords
  const kws = ['void','int','byte','bool','String','unsigned','long','if','else','while','for','return','true','false','include','define','const'];
  for(const kw of kws) code = code.replace(new RegExp(`\\b${kw}\\b`,'g'), `<span class="kw">${kw}</span>`);
  // numbers
  code = code.replace(/\b(0x[0-9A-Fa-f]+|\d+)\b/g, '<span class="num">$1</span>');
  document.getElementById('firmwareCode').innerHTML = code;
}

function copyFirmware() {
  navigator.clipboard.writeText(FIRMWARE).then(()=>alert('Firmware copied to clipboard!'));
}
</script>
</body>
</html>
